# 新功能使用指南

## 功能1：页面缓存机制 💾

### 功能说明
自动保存用户输入的基本信息和生成的报告到浏览器本地存储（localStorage），避免用户每次访问都需要重新输入，刷新页面后也能继续查看报告。

### 使用方法

#### 1. 表单数据自动保存
- 在输入表单中填写年月日时、性别、昵称等信息
- 系统会自动将这些信息保存到浏览器缓存
- 无需手动操作，输入即保存

#### 2. 报告数据自动保存
- 生成八字排盘后，八字数据会自动缓存
- 生成文本报告或可视化报告后，报告内容会自动缓存
- 当前步骤和报告模式也会被记录

#### 3. 智能恢复
- **刷新页面**：页面刷新后，系统会自动恢复到上次的状态
  - 如果在步骤1，恢复表单输入数据
  - 如果在步骤2，恢复八字排盘结果
  - 如果已生成报告，直接显示报告内容
- **关闭重开**：关闭浏览器后24小时内重新打开，数据仍然保留
- **自动过期**：报告缓存24小时后自动过期清除

#### 4. 清除缓存
- 点击页面右上角的"重新开始"按钮
- 系统会清除所有缓存数据（表单数据 + 报告数据）
- 页面重置为初始状态

### 技术实现

#### 表单数据缓存
- **存储键**：`bazi_form_cache`
- **缓存字段**：year, month, day, hour, gender, nickname, timeUnknown
- **不缓存字段**：redeemCode（兑换码）、emotionText（情绪文本）
- **实现位置**：`src/components/InputForm.tsx`

#### 报告数据缓存
- **存储键**：`bazi_report_cache`
- **缓存字段**：
  - `baziData`: 八字数据
  - `report`: 文本报告内容
  - `visualReport`: 可视化报告数据
  - `reportMode`: 当前报告模式（text/visual）
  - `currentStep`: 当前步骤（1/2）
  - `timestamp`: 缓存时间戳
- **过期时间**：24小时
- **实现位置**：`src/pages/HomePage.tsx`

### 注意事项
- 缓存数据仅保存在本地浏览器，不会上传到服务器
- 清除浏览器数据会同时清除缓存
- 不同浏览器的缓存是独立的
- 报告缓存24小时后自动过期
- 点击"重新开始"会清除所有缓存

---

## 功能2：Bento Grid可视化报告 📊

### 功能说明
全新的卡片式命理仪表盘，采用Bento Grid布局，将分析结果以8个维度的卡片形式直观展示。

### 使用方法

#### 1. 生成可视化报告
在步骤2（八字排盘完成后），有两个按钮：
- **文本报告**：生成传统的文本格式报告
- **可视化报告**：生成卡片式的可视化报告

点击"可视化报告"按钮，等待AI生成结构化数据。

#### 2. 查看报告
可视化报告包含以下内容：

**总体评价卡片**
- 80字左右的总体评价
- 综合评分（1-10分）
- 评分进度条可视化

**8个维度分析卡片**
1. **交易运势** 💹 - 投资理财能力、风险偏好、适合的投资方向
2. **性格分析** 👤 - 基于日主的性格特征、优势与劣势
3. **事业行业** 💼 - 适合的职业方向、行业选择
4. **发展风水** 🧭 - 有利的方位、颜色、环境布置
5. **财富层级** 💰 - 财运分析、财富积累方式
6. **婚姻情感** ❤️ - 感情运势、婚姻状态分析
7. **身体健康** 🏥 - 需要注意的健康问题、养生建议
8. **六亲关系** 👨‍👩‍👧‍👦 - 家庭关系、与父母子女的互动模式

每个卡片包含：
- 图标和标题
- 50-80字的分析内容
- 1-10分的评分
- 评分进度条
- 主题色彩（紫、蓝、绿、黄、青、红、橙、粉）

#### 3. 切换报告模式
如果同时生成了文本报告和可视化报告，可以在报告页面顶部看到切换按钮：
- **文本报告**：查看详细的文字分析
- **可视化报告**：查看卡片式的直观展示

点击按钮即可在两种模式之间自由切换。

### 技术实现

#### 前端
- **组件**：`src/components/VisualReport.tsx`
- **布局**：响应式网格（移动端1列、平板2列、桌面3列）
- **动画**：卡片悬停效果、过渡动画
- **主题**：深色背景、渐变色卡片

#### 后端
- **Prompt**：`supabase/functions/generate-report/prompt-visual.ts`
- **输出格式**：结构化JSON数据
- **API参数**：`outputFormat: 'visual'`

#### 数据结构
```typescript
interface VisualReportData {
  summary: string;           // 总体评价
  summary_score: number;     // 总体评分 1-10
  cards: VisualReportCard[]; // 8个维度的卡片
}

interface VisualReportCard {
  key: string;      // 唯一标识
  title: string;    // 卡片标题
  content: string;  // 分析内容（50-80字）
  score: number;    // 评分（1-10）
  color: string;    // 主题色
}
```

### 设计特点
- **直观性**：评分和进度条让用户一目了然
- **美观性**：渐变色主题、精美动画效果
- **响应式**：适配各种屏幕尺寸
- **交互性**：卡片悬停效果、模式切换

### 注意事项
- 可视化报告需要消耗一次兑换码
- 生成时间可能比文本报告稍长（需要AI输出结构化JSON）
- 如果AI返回的JSON格式不正确，会显示错误提示

---

## 常见问题

### Q1: 缓存数据会丢失吗？
A: 表单数据会一直保留，除非手动清除。报告数据会在24小时后自动过期清除。清空浏览器数据也会清除所有缓存。

### Q1.5: 刷新页面后报告还在吗？
A: 在！报告数据会自动缓存，刷新页面后会自动恢复到上次的状态，包括：
- 当前步骤（步骤1/步骤2/报告页面）
- 八字排盘结果
- 文本报告内容
- 可视化报告内容
- 当前查看的报告模式

### Q2: 可以同时生成两种报告吗？
A: 可以！先生成一种报告，然后返回步骤2，再生成另一种报告。两种报告都会保留，可以自由切换查看。

### Q3: 可视化报告的评分是如何计算的？
A: 评分由AI根据八字信息客观评估，范围是1-10分。不同维度的评分标准不同，具体由AI的分析逻辑决定。

### Q4: 为什么有时候可视化报告生成失败？
A: 可能的原因：
- AI返回的JSON格式不正确
- 网络连接问题
- 兑换码已用完

如果失败，可以查看浏览器控制台的错误信息，或尝试重新生成。

---

## 更新日志
详见 [CHANGELOG.md](../CHANGELOG.md)

